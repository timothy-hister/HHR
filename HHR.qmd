---
title: "Health Human Resources Supply and Demand Forecasting"
subtitle: "BC Cancer"
date: today
author: Tim Hister
format: 
  revealjs:
    incremental: true
    auto-animate: true
execute:
  echo: true
  output-location: fragment
filters:
  - fragment-shortcode.lua
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: true

pacman::p_load(tidyverse, hsiaR, reactable, tidymodels)
set.seed(10)

params = list(
  start_year = "FY2020/21",
  num_years_to_forecast = 10L
)
```

# Introduction

## Motivation

![](images/clipboard-2192972124.png){.fragment}

## Project Plan

-   Forecast supply and demand of physicians in B.C.
-   $gap_t = demand_t - supply_t$
-   Physician Headcount and "full time equivalent" (FTE; measure for physician productivity)
-   Multiple models; keep two best.
-   "Best" == ???

## `hsiaR`

-   R package I wrote for hsiaR division at MOH
-   Features: MOH database, fiscal years, BC Health Authorities, and much, much more!

::: fragment
```{r}
hsiaR::hiQuery
```
:::

# Data

## Data Overall

-   ![Ministry of Health datasets](https://www2.gov.bc.ca/gov/content/health/conducting-health-research-evaluation/data-access-health-data-central/health-sector-partner-access-to-data/third-party-access), such as ![MSP](https://healthdataplatformbc.ca/hdpbc-data).
-   Not publicly available
-   SQL code/random numbers

## Specialties

-   Doctors registered with MSP

::: fragment
```{r}
#| eval: false
hiQuery("select distinct mrspec Specialty_Code, spec_desc Specialty 
        from msea_team_lvl2.vt4 order by 1")
```
:::

# Supply

## Headcount

-   $headcount_t = headcount_{t-1} + entrants_t - retirees_{t-1}$
-   $entrants_t$: average of the three most recent years of available data.
-   Retirements: logistic regression
-   $\begin{aligned}[t]
retirement\_prob = \beta_0 &+ \beta_1 \cdot rurality \\
                           &+ \beta_2 \cdot age + \beta_3 \cdot age^2 \\
                           &+ \beta_4 \cdot gender \\
                           &+ \beta_5 \cdot model\_specific\_vars
\end{aligned}$

## Specialties

```{r}
specialties = tibble(
  spec_id = 0:3,
  spec = c("FAMILY MEDICINE", "DERMATOLOGY", "NEUROLOGY", "PSYCHIATRY")
)

specialties
```


## (Fake) Data Set

```{r}
n = 1000L

phys_df = tibble(
  id = 1:n,
  spec_id = sample(specialties$spec_id, n, replace = T), 
  age = as.integer(rnorm(n, 45, 12)) |> pmax(20L),
  rurality = runif(n),
  gender = sample(c("M","F"), n, T)
) |>
  crossing(i = 0:2) |> # three years of data per physician
  mutate(age = age + i) |>
  mutate(fiscal = Vectorize(hsiaR::fiscal_add)(params$start_year, i)) |>
  select(-i) |>
  mutate(age2 = age^2) |>
  mutate(retired = rurality + (age + age2) + if_else(gender == "M", 10, 0) + rnorm(1, 2000, 100)) |> # linear combination of regressors plus 'normal' noise
  mutate(retired = retired > quantile(retired, .9)) # 90% don't retire
  
  
# remove all years after retirement
phys_df = phys_df |>
  anti_join(
    phys_df |>
      filter(retired) |>
      arrange(id, fiscal) |>
      group_by(id) |>
      slice_head(n=1),
    by=join_by(id==id, fiscal > fiscal)
)

# clean up columns and arrange
phys_df = phys_df |>
  mutate(gender = as_factor(gender)) |>
  mutate(retired = as_factor(retired)) |>
  mutate(fiscal_id = Vectorize(hsiaR::fiscal_diff)(params$start_year, fiscal)) |>
  select(id, spec_id, fiscal_id, age, age2, gender, rurality, retired) |>
  arrange(id, fiscal_id)


head(phys_df)
```


## Data

```{r}
#| eval: false

gridExtra::grid.arrange(
  select(phys_df, id, spec_id, age) |> 
    pivot_longer(cols = c(spec_id, age)) |>
    ggplot(aes(x=value, fill=name)) +
    facet_wrap(~name, scales='free') +
    geom_histogram() +
    ggthemes::theme_clean() +
    scale_fill_manual(values = viridis::viridis(4)[1:2]) + 
    guides(fill = 'none') + 
    labs(x=NULL, y=NULL),
  
  select(phys_df, id, gender, retired) |> 
    mutate(across(2:3, as.factor)) |>
    pivot_longer(cols = c(gender, retired)) |>
    ggplot(aes(x=value, fill=name)) +
    facet_wrap(~name, scales='free') +
    geom_bar() +
    ggthemes::theme_clean() + 
    scale_fill_manual(values = viridis::viridis(4)[3:4]) + 
    guides(fill = 'none') +
    labs(x=NULL, y=NULL)
)
```

## Data

```{r}
#| echo: false

gridExtra::grid.arrange(
  select(phys_df, id, spec_id, age) |> 
    pivot_longer(cols = c(spec_id, age)) |>
    ggplot(aes(x=value, fill=name)) +
    facet_wrap(~name, scales='free') +
    geom_histogram() +
    ggthemes::theme_clean() +
    scale_fill_manual(values = viridis::viridis(4)[1:2]) + 
    guides(fill = 'none') + 
    labs(x=NULL, y=NULL),
  
  select(phys_df, id, gender, retired) |> 
    mutate(across(2:3, as.factor)) |>
    pivot_longer(cols = c(gender, retired)) |>
    ggplot(aes(x=value, fill=name)) +
    facet_wrap(~name, scales='free') +
    geom_bar() +
    ggthemes::theme_clean() + 
    scale_fill_manual(values = viridis::viridis(4)[3:4]) + 
    guides(fill = 'none') +
    labs(x=NULL, y=NULL)
)
```

```{r}
models = tibble(
  model_id = 1:2,
  equation = c("retired ~ rurality + age + age2 + gender", "retired ~ rurality + age + age2 + gender + fiscal_id")
)
```





## Logistic

```{r}
logits = specialties |>
  crossing(models) |>
  select(spec_id, model_id, equation) |> 
  rowwise(spec_id, model_id, equation) |>
  mutate(data = list(logistic_reg(mode = 'classification', engine = 'glm') |> 
      fit(as.formula(equation), data=filter(phys_df, spec_id == spec_id)))
  )

logits = filter(logits, model_id == 1)
```

```{r}
entrants = tibble(
  spec_id = sample(specialties$spec_id, n/10, replace = T),
  age = as.integer(rnorm(n/10, 35, 12)) |> pmax(20L), # a bit younger than the previous pool
  rurality = runif(n/10),
  gender = sample(c("M","F"), n/10, T)
) |>
  nest_by(spec_id)
```

```{r}
actuals = phys_df |>
  nest_by(spec_id)
```

```{r}
forecasts = actuals |>
  mutate(data = list(
    data |>
      filter(fiscal_id == 2) |>
      mutate(forecast_yr = 0, .before=1))
  )


x = map(forecasts$spec_id, function(spec) {
#x = map(1:1, function(spec) {
  results = tibble()
  logit = filter(logits, spec_id == spec) |> pull(data) |> first()
  df_init = forecasts |>
      filter(spec_id == spec) |>
      pull(data) |>
      first() |> 
      filter(forecast_yr == 0) |>
      select(forecast_yr, fiscal_id, id, age, age2, gender, rurality)
  
  accumulate(0:params$num_years_to_forecast, function(df, h) {
    
    df = bind_cols(df, bind_cols(predict(logit, df, type='prob')))
    
    df = df |>
      mutate(u = runif(1, 0, 1)) |>
      mutate(retired = .pred_TRUE > u) |>
      filter(!retired) |>
      mutate(forecast_yr = h + 1) |>
      mutate(age = age + 1) |>
      mutate(age2 = age^2) |>
      mutate(fiscal_id = fiscal_id + 1) |>
      select(forecast_yr, fiscal_id, id, age, age2, gender, rurality)
    
  }, .init = df_init) |>
    bind_rows()
})

x[[1]]$forecast_yr
```

